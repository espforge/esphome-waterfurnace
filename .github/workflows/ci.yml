name: CI

on:
  pull_request:
    paths:
      - "*.yaml"
      - "components/**"
      - "tests/**"
      - ".github/workflows/ci.yml"
  schedule:
    - cron: "0 0 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install gtest
        run: sudo apt-get install -y libgtest-dev
      - name: Run unit tests
        run: make -C tests/unit test

  esphome:
    name: ESPHome ${{ matrix.esphome-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        esphome-version:
          - stable
          - dev
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Create secrets.yaml
        run: |
          cat > tests/secrets.yaml <<EOF
          wifi_ssid: "placeholder"
          wifi_password: "placeholder"
          EOF
      - name: Config validation
        run: |
          docker run --rm \
            -v "$PWD":/config \
            -w /config/tests \
            ghcr.io/esphome/esphome:${{ matrix.esphome-version }} \
            config waterfurnace-test.yaml
      - name: Compile firmware
        run: |
          docker run --rm \
            -v "$PWD":/config \
            -w /config/tests \
            ghcr.io/esphome/esphome:${{ matrix.esphome-version }} \
            compile waterfurnace-test.yaml
      - name: Example config validation
        run: |
          cat > .waterfurnace-test-example.yaml <<'EOF'
          packages:
            example: !include waterfurnace-esp32-s3.yaml

          substitutions:
            component_source: components

          wifi:
            ssid: test-network
            password: test-password
          EOF
          docker run --rm \
            -v "$PWD":/config \
            -w /config \
            ghcr.io/esphome/esphome:${{ matrix.esphome-version }} \
            config .waterfurnace-test-example.yaml
